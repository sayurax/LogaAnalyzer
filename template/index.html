<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>File Upload and Request Path Counts</title>
  <!-- Include DataTables CSS & jQuery (make sure to include these if not already present) -->
  <!-- Include DataTables CSS -->
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <!-- Include jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- Include DataTables JS -->
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>

    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            /* background-color: #f4f4f9; */
            color: #333;
        }

        h1 {
            font: bold 16pt Arial, Helvetica, Geneva, sans-serif;
            color: #336699;
        }

        form {
            display: flex;
            flex-direction: column;
            gap: 1.2rem;
        }

        label {
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        input[type="file"] {
            padding: 0.6rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        input[type="file"]:hover, input[type="file"]:focus {
            border-color: #007BFF;
            outline: none;
        }

        button {
            padding: 0.8rem;
            background-color: #007BFF;
            color: white;
            font-size: 1rem;
            font-weight: bold;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: #0056b3;
        }

        .result h2 {
            font: bold 10pt Arial, Helvetica, Geneva, sans-serif;
            color: black;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        table th, table td {
            padding: 0.8rem;
            border: 1px solid #ddd;
            text-align: left;
        }

        table.dataTable tbody td {
            font: 8pt Arial, Helvetica, Geneva, sans-serif;
            color: black;
        }

        table.dataTable thead th {
            font: bold 9pt Arial, Helvetica, Geneva, sans-serif;
            color: black;
        }


        table tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        table tbody tr:hover {
            background-color: #f1f1f1;
        }

        @media (max-width: 768px) {
            .container {
                margin: 20px;
                padding: 1.5rem;
            }

            button {
                font-size: 0.9rem;
                padding: 0.6rem;
            }

            input[type="file"] {
                font-size: 0.9rem;
            }

            .result h2 {
                font: bold 10pt Arial, Helvetica, Geneva, sans-serif;
                color: black;
            }
        }

        /* Floating plus button */
        .floating-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 50%;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        .file-info h2 {
            font: bold 10pt Arial, Helvetica, Geneva, sans-serif;
            color: black;
        }

        .chart-container {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            margin-top: 20px;
            height: 400px;  /* Add a consistent height */
        }

    </style>
</head>
<body>
    <div class="container">
        <h1>File Upload and Request Path Counts</h1>

        <form action="/upload" method="post" enctype="multipart/form-data">
            <label for="uploadFile">Select a file:</label>
            <input type="file" name="uploadedFile" multiple required>
            <input type="hidden" name="uniqueID" id="uniqueID"> 
            <button type="submit">Upload</button>
        </form>

        <!-- Initially Hidden Charts -->
<div id="chartsContainer" style="display: none;">

    <!-- Chart 1: Request Path Pie Chart -->
    <div class="chart-container">
        <div style="text-align: center; margin-bottom: 10px;">
            <label for="countThreshold"><strong>Show request paths with count greater than:</strong></label>
            <input type="number" id="countThreshold" value="1" min="1" />
            <button id="updateChartBtn">Update Chart</button>
        </div>
        <canvas id="myChart1" style="width: 700px; max-width: 700px;"></canvas>
    </div>

    <!-- Chart 2: Average Time Pie Chart -->
    <div class="chart-container">
        <div style="text-align: center; margin-bottom: 10px;">
            <label for="avgTimeThreshold"><strong>Show request paths with average time greater than (ms):</strong></label>
            <input type="number" id="avgTimeThreshold" value="1000" min="1" />
            <button id="updateAvgTimeBtn">Update Chart</button>
        </div>
        <canvas id="myChart2" style="width:700px; max-width:700px;"></canvas>
    </div>

    <!-- Chart 3: Request Query Pie Chart -->
    <div class="chart-container">
        <div style="text-align: center; margin-bottom: 10px;">
            <label for="queryCountThreshold"><strong>Show queries with count greater than:</strong></label>
            <input type="number" id="queryCountThreshold" value="100" min="1" />
            <button id="updateQueryPieChartBtn">Update Chart</button>
        </div>
        <canvas id="queryPieChart" style="width:700px; max-width:700px;"></canvas>
    </div>

    <!-- Chart 4: Request Query Bar Chart -->
    <div class="chart-container">
        <div style="text-align: center; margin-bottom: 10px;">
            <label for="queryBarThreshold"><strong>Show queries in bar chart with count greater than:</strong></label>
            <input type="number" id="queryBarThreshold" value="50" min="1" />
            <button id="updateQueryBarChartBtn">Update Chart</button>
        </div>
        <canvas id="queryBarChart" style="width:100%; max-width:700px;"></canvas>
    </div>

</div>

        <div class="file-info">
            <h2>Uploaded Files:</h2>
            {{if .FileNames}}
                <ul>
                    {{range .FileNames}}
                        <li>{{.}}</li>
                    {{end}}
                </ul>
            {{else}}
                <p>No files uploaded yet.</p>
            {{end}}
        </div>

        <!-- Show Charts when file is uploaded -->
        <script>
            document.addEventListener("DOMContentLoaded", function () {
                document.getElementById("chartsContainer").style.display = "block";
            });
        </script>    
    
        <!-- Display results dynamically using Go's template engine -->
        {{ if .RequestPathStats }}
        <div class="result">
            <h2>HTTP-IN-Response Request Path Counts:</h2>
            <table id="requestPathTable" class="display">
                <thead>
                    <tr>
                        <th>Request Path</th>
                        <th>Count</th>
                        <th>Average Time (ms)</th>
                        <th>95th Percentile (ms)</th>
                        <th>Maximum Time (ms)</th>
                        <th>Minimum Time (ms)</th>
                    </tr>
                </thead>
                <tbody>
                    {{ range $path, $details := .RequestPathStats }}
                    <tr>
                        <td class="request-path" data-path="{{ $path }}">{{ $path }}</td>
                        <td>{{ $details.Count }}</td>
                        <td>{{ printf "%.2f" $details.AverageTime }}</td>%
                        <td>{{ printf "%.2f" $details.Percentile}}</td>
                        <td>{{ printf "%.2f" $details.MaxTime}}</td>
                        <td>{{ printf "%.2f" $details.MinTime}}</td>
                        
                        
                    </tr>
                    {{ end }}
                </tbody>
            </table>            
        </div>
        {{ end }}

        {{ if .QueryMetrics }}
        <div class="result">
            <h2>Request Query Metrics (Excluding callTypes:HTTP-IN-Request & HTTP-IN-Response):</h2>
            <table id="queryMetricsTable" class="display">
                <thead>
                    <tr>
                        <th>Elapsed Time (ms)</th>
                        <th>Count</th>
                        <th>Maximum Time (ms)</th>
                        <th>Elapsed Time Per Execution(ms)</th>
                        <th>Minimum Time (ms)</th>
                        <th>95th Percentile (ms)</th>
                        <th>Request Query</th>
                    </tr>
                </thead>
                <tbody>
                    {{ range $query, $metrics := .QueryMetrics }}
                    <tr>
                        <td>{{ printf "%.2f" $metrics.TotalTime}}</td>
                        <td class="all-queries">{{ $metrics.Count }}</td>
                        <td>{{ printf "%.2f" $metrics.MaxTime }}</td>
                        <td>{{ printf "%.2f" $metrics.AverageTime }}</td>
                        <td>{{ printf "%.2f" $metrics.MinTime }}</td>
                        <td>{{ printf "%2f" $metrics.Percentile}}</td>
                        <td>{{ $query }}</td>
                    </tr>
                    {{ end }}
                </tbody>
            </table>

            <h2>HTTP-In-Responses Data</h2>
            <table id="requestTable" class="display">
                <thead>
                    <tr>
                        <th>Timestamp</th>
                        <th>Correlation ID</th>
                        <th>Thread ID</th>
                        <th>Duration</th>
                        <th>Call Type</th>
                        <th>Start Time</th>
                        <th>Method Name</th>
                        <th>Request Query</th>
                        <th>Request Path</th>
                    </tr>
                </thead>
                <tbody>{{range .HttpResponses}}
                    <tr>
                        <td>{{ .Timestamp }}</td>
                        <td>{{ .CorrelationId }}</td>
                        <td>{{ .ThreadId }}</td>
                        <td>{{ .TotalDurationForRequest }}</td>
                        <td>{{ .CallType }}</td>
                        <td>{{ .StartTime }}</td>
                        <td>{{ .MethodName }}</td>
                        <td>{{ .RequestQuery }}</td>
                        <td>{{ .RequestPath }}</td>
                    </tr>
                    {{end}}
                </tbody>                                
            </table>
            <button class="floating-btn" type="button" onclick="getNewWindow()">+</button>
        </div>
        {{ end }}
    </div>

    <script>
        // Initialize DataTables
        $(document).ready(function () {
            // Ensure DataTables is initialized only once
            if (!$.fn.dataTable.isDataTable('#requestPathTable')) {
                $('#requestPathTable').DataTable({
                    paging: true,
                    searching: true,
                    ordering: true,
                    info: true,
                    lengthChange: true,
                    pageLength: 10,
                    columnDefs: [
                        { type: "num", targets: 3 } // Ensure Average Time column is treated as a number
                    ],
                    order: [[3, "desc"]] // Sort by Average Time (ms) in descending order
                });
            }

            // Click event for navigating to request details
            $(document).on('click', '.request-path', function () {
                var path = $(this).data('path');
                console.log('Navigating to:', path);
                console.log('Tab UUID:', window.name); // Tab UUID print

                window.location.href = '/request-details?path=' + encodeURIComponent(path) + '&tabUUID=' + encodeURIComponent(window.name);
            });
         });

        // Initialize DataTables for the Query Stats table
        $(document).ready(function () {
            console.log("Initializing DataTable...");

            $('#queryMetricsTable').DataTable({
                paging: true,
                searching: true,
                ordering: true,
                info: true,
                lengthChange: true,
                pageLength: 10,
                order: [[5, "desc"]]
            });

            console.log("DataTable initialized successfully.");

            // Attach click event to the executions cells
            $('#queryMetricsTable tbody').on('click', '.all-queries', function () {
                console.log("Row clicked in queryMetricsTable.");

                // Retrieve the query text from the last cell in the clicked row
                var query = $(this).closest('tr').find('td:last').text().trim();
                console.log("Extracted query:", query);

                // Get tabUUID from the URL parameters
                var tabUUID = window.name;
                console.log("Tab UUID:", tabUUID);

                if (query && tabUUID) {
                    console.log("Redirecting to queryExecutions page...");
                    window.location.href = "/queryExecutions?query=" + encodeURIComponent(query) + "&tabUUID=" + encodeURIComponent(tabUUID);
                } else {
                    console.error("Missing query or tabUUID");
                    alert("Error: Missing query or tabUUID");
                }
            });
        });


        $(document).ready(function (){
            $('#requestTable').DataTable({
                paging: true,
                searching: true,
                ordering: true,
                info: true,
                lengthChange: true,
                pageLength: 10,
                order: [[3, "desc"]],
            })
        })

        // Function to generate a simple UUID
        function generateUUID() {
            return 'xxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0,
                    v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // Function to ensure the tab has a UUID
        function ensureTabUUID() {
            // If window.name doesn't already have a UUID, assign one
            if (!window.name) {
                const uuid = generateUUID();
                window.name = uuid;
                console.log('Tab UUID set:', window.name);
            } else {
                console.log('Existing Tab UUID:', window.name);
            }
            // Set the UUID to the hidden input field
            document.getElementById('uniqueID').value = window.name;
        }

        // Function to open a new tab and handle UUID for isolation
        function getNewWindow() {
            // Generate a UUID for the new tab
            const uuid = generateUUID();

            // Open a new tab with the same 'index.html' and set window.name to UUID for isolation
            const newWindow = window.open(location.href, '_blank');            
        }

        // Ensure each tab has a unique ID
        ensureTabUUID();

        //Script for chart1 Pie chart
        document.addEventListener("DOMContentLoaded", function () {
            let chartInstance = null;

            function generateColors(count) {
                let colors = [];
                for (let i = 0; i < count; i++) {
                    let hue = (i * 137.5) % 360;
                    colors.push(`hsl(${hue}, 70%, 50%)`);
                }
                return colors;
            }

            function updateChart(threshold) {
                const xValues = [];
                const yValues = [];

                document.querySelectorAll("#requestPathTable tbody tr").forEach(row => {
                    let requestPath = row.querySelector(".request-path").dataset.path;
                    let count = parseInt(row.cells[1].innerText);

                    if (count > threshold) {
                        xValues.push(requestPath);
                        yValues.push(count);
                    }
                });

                // Destroy existing chart if any
                if (chartInstance) {
                    chartInstance.destroy();
                }

                const chartContainer = document.getElementById("chartsContainer");

                if (xValues.length > 0 && yValues.length > 0) {
                    chartContainer.style.display = "block"; // ✅ Show chart container

                    let dynamicColors = generateColors(xValues.length);

                    chartInstance = new Chart("myChart1", {
                        type: "pie",
                        data: {
                            labels: xValues,
                            datasets: [{
                                backgroundColor: dynamicColors,
                                data: yValues,
                                borderWidth: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: false,
                                tooltip: false
                            },
                            title: {
                                display: true,
                                text: `Request Path vs Counts (Count > ${threshold})`
                            },
                            onHover: function (e, activePoints) {
                                if (activePoints.length > 0) {
                                    var index = activePoints[0]._index;
                                    console.log('Hovered over path:', xValues[index]);
                                }
                            },
                            onClick: function (e) {
                                var activePoints = chartInstance.getElementsAtEventForMode(e, 'nearest', { intersect: true }, true);
                                if (activePoints.length > 0) {
                                    var index = activePoints[0]._index;
                                    var selectedPath = xValues[index];
                                    console.log('Navigating to request details for path:', selectedPath);
                                    window.location.href = '/request-details?path=' + encodeURIComponent(selectedPath) + '&tabUUID=' + encodeURIComponent(window.name);
                                }
                            }
                        }
                    });
                } else {
                    chartContainer.style.display = "none"; // ❌ Hide if no data
                    console.log(`No request paths with count greater than ${threshold}.`);
                }
            }

            // Initial chart render with default threshold
            updateChart(1);

            // Handle user-defined threshold updates
            document.getElementById("updateChartBtn").addEventListener("click", function () {
                const threshold = parseInt(document.getElementById("countThreshold").value) || 1;
                updateChart(threshold);
            });
        });


        //Script for Chart2 bar chart (Request Path vs Average time)
        document.addEventListener("DOMContentLoaded", function () {
            let chartInstance = null;
            let fullQueries = []; // Only needed if you use it in the tooltip callback

            function generateColors(count) {
                let colors = [];
                for (let i = 0; i < count; i++) {
                    let hue = (i * 137.5) % 360;
                    colors.push(`hsl(${hue}, 70%, 50%)`);
                }
                return colors;
            }

            function updateAvgTimeChart(threshold) {
                const xValues = [];
                const yValues = [];

                document.querySelectorAll("#requestPathTable tbody tr").forEach(row => {
                    let requestPath = row.querySelector(".request-path").dataset.path;
                    let avgTime = parseFloat(row.cells[2].innerText);

                    if (avgTime > threshold) {
                        xValues.push(requestPath);
                        yValues.push(avgTime);
                    }
                });

                const chartContainer = document.getElementById("chartsContainer");

                if (chartInstance) {
                    chartInstance.destroy();
                }

                if (xValues.length > 0 && yValues.length > 0) {
                    chartContainer.style.display = "block";

                    let dynamicColors = generateColors(xValues.length);

                    chartInstance = new Chart("myChart2", {
                        type: "bar",
                        data: {
                            labels: xValues,
                            datasets: [{
                                backgroundColor: dynamicColors,
                                data: yValues
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                tooltip: {
                                    callbacks: {
                                        title: function (tooltipItems) {
                                            let index = tooltipItems[0].dataIndex;
                                            return fullQueries[index] || xValues[index]; // fallback to path if full query is not defined
                                        },
                                        label: function (tooltipItem) {
                                            return `Avg Time: ${tooltipItem.raw} ms`;
                                        }
                                    }
                                }
                            },
                            legend: { display: false },
                            title: {
                                display: true,
                                text: `Request Path vs Average Time (ms) (AvgTime > ${threshold}ms)`
                            },
                            onHover: function (event, activeElements) {
                                if (activeElements.length > 0) {
                                    let index = activeElements[0]._index;
                                    let hoveredPath = xValues[index];
                                    console.log('Hovered over path:', hoveredPath);
                                }
                            },
                            onClick: function (event, elements) {
                                if (elements.length > 0) {
                                    let index = elements[0]._index;
                                    let selectedPath = xValues[index];
                                    console.log('Navigating to request details for path:', selectedPath);
                                    window.location.href = '/request-details?path=' + encodeURIComponent(selectedPath) + '&tabUUID=' + encodeURIComponent(window.name);
                                }
                            }
                        }
                    });
                } else {
                    chartContainer.style.display = "none";
                    console.log(`No request paths with average time greater than ${threshold}ms.`);
                }
            }

            // Initial render with default threshold
            updateAvgTimeChart(1000);

            // Event listener for update button
            document.getElementById("updateAvgTimeBtn").addEventListener("click", function () {
                const threshold = parseInt(document.getElementById("avgTimeThreshold").value) || 1000;
                updateAvgTimeChart(threshold);
            });
        });


        // Script for Chart3 - Pie chart (Request Query vs Count)
        document.addEventListener("DOMContentLoaded", function () {
            let queryChart; // Hold the chart instance
            const fullQueries = []; // Store full queries for click navigation

            function generateColors(count) {
                let colors = [];
                for (let i = 0; i < count; i++) {
                    let hue = (i * 137.5) % 360;
                    colors.push(`hsl(${hue}, 70%, 50%)`);
                }
                return colors;
            }

            function updateQueryPieChart() {
                const threshold = parseInt(document.getElementById("queryCountThreshold").value) || 100;

                const xValues = [];
                const yValues = [];
                fullQueries.length = 0; // Clear the previous full queries

                document.querySelectorAll("#queryMetricsTable tbody tr").forEach(row => {
                    const query = row.cells[6].innerText;
                    const count = parseInt(row.cells[1].innerText);

                    if (count > threshold) {
                        fullQueries.push(query);
                        const truncatedQuery = query.length > 30 ? query.substring(0, 30) + "..." : query;
                        xValues.push(truncatedQuery);
                        yValues.push(count);
                    }
                });

                if (queryChart) {
                    queryChart.destroy(); // Destroy previous chart instance
                }

                if (xValues.length > 0 && yValues.length > 0) {
                    const dynamicColors = generateColors(xValues.length);
                    const ctx = document.getElementById("queryPieChart");

                    queryChart = new Chart(ctx, {
                        type: "pie",
                        data: {
                            labels: xValues,
                            datasets: [{
                                backgroundColor: dynamicColors,
                                data: yValues,
                                borderWidth: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: false,
                                tooltip: false
                            },
                            title: {
                                display: true,
                                text: `Request Queries vs Counts (Count > ${threshold})`
                            },
                            onHover: function (e, activePoints) {
                                if (activePoints.length > 0) {
                                    const index = activePoints[0]._index;
                                    console.log('Hovered over query:', fullQueries[index]);
                                }
                            },
                            onClick: function (e) {
                                const activePoints = queryChart.getElementsAtEventForMode(e, 'nearest', { intersect: true }, true);
                                if (activePoints.length > 0) {
                                    const index = activePoints[0]._index;
                                    const selectedQuery = fullQueries[index];
                                    console.log('Navigating to queryExecutions for query:', selectedQuery);

                                    window.location.href = `/queryExecutions?query=${encodeURIComponent(selectedQuery)}&tabUUID=${encodeURIComponent(window.name)}`;
                                }
                            }
                        }
                    });
                } else {
                    console.log(`No queries with count greater than ${threshold}.`);
                }
            }

            // Initial chart render
            updateQueryPieChart();

            // Re-render chart when Update button is clicked
            document.getElementById("updateQueryPieChartBtn").addEventListener("click", updateQueryPieChart);
        });


        // Script for Chart4 - Bar chart (Request Query vs Average Time)
        document.addEventListener("DOMContentLoaded", function () {
            let chartInstance = null;

            // Function to generate distinct colors dynamically
            function generateColors(count) {
                let colors = [];
                for (let i = 0; i < count; i++) {
                    let hue = (i * 137.5) % 360; // Distribute hues evenly
                    colors.push(`hsl(${hue}, 70%, 50%)`);
                }
                return colors;
            }

            // Function to build the chart based on the threshold
            function buildQueryBarChart(threshold) {
                let xValues = [];
                let yValues = [];
                let fullQueries = [];

                document.querySelectorAll("#queryMetricsTable tbody tr").forEach(row => {
                    let query = row.cells[6].innerText.trim(); // Request Query
                    let avgTime = parseFloat(row.cells[3].innerText.trim()); // Average Time

                    if (avgTime > threshold) {
                        fullQueries.push(query);

                        let truncatedQuery = query.length > 30 ? query.substring(0, 30) + "..." : query;
                        xValues.push(truncatedQuery);
                        yValues.push(avgTime);
                    }
                });

                if (chartInstance) {
                    chartInstance.destroy(); // Destroy previous chart instance if it exists
                }

                if (xValues.length > 0 && yValues.length > 0) {
                    let dynamicColors = generateColors(xValues.length);

                    const ctx = document.getElementById("queryBarChart").getContext("2d");
                    chartInstance = new Chart(ctx, {
                        type: "bar",
                        data: {
                            labels: xValues,
                            datasets: [{
                                backgroundColor: dynamicColors,
                                data: yValues
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                x: {
                                    ticks: {
                                        maxRotation: 45,
                                        minRotation: 45,
                                        callback: function(value, index) {
                                            return xValues[index];
                                        }
                                    }
                                },
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'Average Time (ms)'
                                    }
                                }
                            },
                            plugins: {
                                tooltip: {
                                    callbacks: {
                                        title: function(tooltipItems) {
                                            let index = tooltipItems[0].dataIndex;
                                            return fullQueries[index];
                                        },
                                        label: function(tooltipItem) {
                                            return `Avg Time: ${tooltipItem.raw} ms`;
                                        }
                                    }
                                }
                            },
                            legend: { display: false },
                            title: {
                                display: true,
                                text: `Request Queries vs Average Time (ms) (AvgTime > ${threshold}ms)`
                            },
                            onHover: function(e, activePoints) {
                                if (activePoints.length > 0) {
                                    var index = activePoints[0].index;
                                    var hoveredQuery = fullQueries[index];
                                    console.log('Hovered over query:', hoveredQuery);
                                }
                            },
                            onClick: function (e) {
                                var activePoints = chartInstance.getElementsAtEventForMode(e, 'nearest', { intersect: true }, true);
                                if (activePoints.length > 0) {
                                    var index = activePoints[0].index;
                                    var selectedQuery = fullQueries[index];
                                    console.log('Navigating to queryExecutions for query:', selectedQuery);

                                    window.location.href = `/queryExecutions?query=${encodeURIComponent(selectedQuery)}&tabUUID=${encodeURIComponent(window.name)}`;
                                }
                            }
                        }
                    });
                } else {
                    console.log(`No query metrics with an average time greater than ${threshold}ms.`);
                }
            }

            // Initial chart render with default threshold
            const defaultThreshold = parseInt(document.getElementById("queryBarThreshold").value);
            buildQueryBarChart(defaultThreshold);

            // Update chart when button is clicked
            document.getElementById("updateQueryBarChartBtn").addEventListener("click", function () {
                const newThreshold = parseInt(document.getElementById("queryBarThreshold").value);
                buildQueryBarChart(newThreshold);
            });
        });


        //Toggle button js
        document.getElementById('toggleDarkMode').addEventListener('click', function () {
            document.body.classList.toggle('dark-mode');

        // Optional: Save preference to localStorage
        if (document.body.classList.contains('dark-mode')) {
            localStorage.setItem('theme', 'dark');
        } else {
            localStorage.setItem('theme', 'light');
        }
        });

        // On load: apply saved theme
        window.onload = function () {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
            }
        };   

    </script>    
</body>
</html>
